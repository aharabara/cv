<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Platform: How serialization groups and serializer context work</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .badge-inline {
            display: inline-block;
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            user-select: none;
            border: 1px solid;
            margin: 0 2px;
        }
        .json-key { color: #9cdcfe; }
        .json-string { color: #ce9178; }
        .json-number { color: #b5cea8; }
        .code-block .field-block {
           margin-bottom: 0; /* Adjusted */
        }
        /* Syntax Highlighting */
        .php-keyword { color: #c586c0; }
        .php-type { color: #4ec9b0; }
        .php-variable { color: #9cdcfe; }
        .php-string { color: #ce9178; }
        .php-const { color: #4fc1ff; }
        .php-entity-name { color: #4ec9b0; font-weight: bold; }
        .php-comment { color: #6a9955; }
        .php-attr { color: #dcdcaa; }

        /* Method Selector Colors */
        .http-select {
            transition: all 0.2s ease-in-out;
        }
        .http-get {
            background-color: #e6fffa;
            color: #2c7a7b;
            border: 1px solid #a7f3d0;
        }
        .http-post {
            background-color: #ebf8ff;
            color: #2b6cb0;
            border: 1px solid #bee3f8;
        }

        /* Tooltip Styles */
        #entity-code {
            position: relative;
        }
        #entity-code pre {
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 0.9; /* Control line spacing */
        }
        .code-line {
            display: block; /* Use block spans to avoid extra div margins */
            position: relative;
            padding-right: 35px; /* Make space for the icon */
        }
        .tooltip-container {
            position: absolute;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
            z-index: 20;
        }
        .tooltip-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.15);
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .tooltip-icon:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .tooltip-text {
            visibility: hidden;
            width: 320px;
            background-color: #1f2937; /* bg-gray-800 */
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 30;
            bottom: 140%;
            left: 50%;
            margin-left: -160px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-family: 'Inter', sans-serif;
            white-space: normal;
            font-size: 13px;
            line-height: 1.6;
        }
        .tooltip-text h4 {
            font-weight: 700;
            color: #dcdcaa;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .tooltip-text b {
            font-weight: 600;
            color: #9cdcfe;
        }
        .tooltip-text ul {
            list-style-type: disc;
            padding-left: 20px;
            margin-top: 8px;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">API Platform: How serialization groups and serializer context work</h1>
            <p class="text-gray-600 mt-2">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –≥—Ä—É–ø–ø–∞–º–∏ —Å —É—á–µ—Ç–æ–º –ø—Ä–∞–≤–∏–ª —Ö–æ—Ä–æ—à–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">

            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°—É—â–Ω–æ—Å—Ç–∏ —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ -->
            <div class="lg:w-1/2 bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">üìö –°—É—â–Ω–æ—Å—Ç–∏</h2>
                <p class="text-gray-500 mb-4">–í—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–Ω–æ—Å—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –µ—ë –≥—Ä—É–ø–ø–∞–º–∏.</p>
                
                <div class="border-b border-gray-200">
                    <nav id="entity-tabs" class="-mb-px flex space-x-4" aria-label="Tabs">
                        <button data-target="Order" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Order.php</button>
                        <button data-target="OrderItem" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">OrderItem.php</button>
                        <button data-target="Product" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Product.php</button>
                    </nav>
                </div>

                <div id="entity-code" class="bg-gray-800 text-white p-4 rounded-b-lg text-sm">
                    <pre><code class="code-block">
                        <div class="tab-panel" id="tab-Order">
<span class="code-line"><span class="php-comment">// Order.php</span></span>
<span class="code-line"><span class="php-attr">#[ApiResource(operations: [</span>
    <div class="tooltip-container">
        <span class="tooltip-icon">üí°</span>
        <div class="tooltip-text">
            <h4>2. Isolate Groups by Entity</h4>
            <p><b>Rule:</b> Give groups names that clearly indicate their association with a specific entity (e.g., the <code>order:</code> prefix for the Order entity).</p>
            <b>Justification:</b>
            <ul>
                <li><b>Conflict Prevention:</b> Prefixes solve the problem of identically named groups for different entities.</li>
                <li><b>Readability:</b> A group like <code>product:read</code> immediately tells you what data it's responsible for.</li>
            </ul>
        </div>
    </div>
</span>
<span class="code-line">    <span class="php-attr">new Get(normalizationContext: ['groups' => [</span>
    <div class="tooltip-container">
        <span class="tooltip-icon">üí°</span>
        <div class="tooltip-text">
            <h4>4. Manage Nesting via the Endpoint Context</h4>
            <p><b>Rule:</b> To load related entities (e.g., <code>OrderItem</code>, <code>Product</code>), add their read groups to the <code>normalizationContext</code> at the operation level.</p>
            <b>Justification:</b>
            <ul>
                <li><b>Data Control:</b> You decide the nesting depth for each endpoint.</li>
                <li><b>Preventing Circular References:</b> Helps avoid infinite recursion.</li>
                <li><b>Performance Optimization:</b> Load only the data the client needs.</li>
            </ul>
        </div>
    </div>
</span>
<span class="code-line">        <span class="badge-inline" data-context-group="order:read" data-operation="Get">Order::GROUP_READ</span>,</span>
<span class="code-line">        <span class="badge-inline" data-context-group="order-item:read" data-operation="Get">OrderItem::GROUP_READ</span>,</span>
<span class="code-line">        <span class="badge-inline" data-context-group="product:read" data-operation="Get">Product::GROUP_READ</span></span>
<span class="code-line">    <span class="php-attr">]]),</span></span>
<span class="code-line">    <span class="php-attr">new Post(</span></span>
<span class="code-line">        <span class="php-attr">denormalizationContext: ['groups' => [</span>
    <div class="tooltip-container">
        <span class="tooltip-icon">üí°</span>
        <div class="tooltip-text">
            <h4>5. Separate Read and Write Contexts</h4>
            <p><b>Rule:</b> Always create separate groups for reading (<code>*:read</code>) and writing (<code>*:write</code>). Use them in <code>normalizationContext</code> and <code>denormalizationContext</code> respectively.</p>
            <b>Justification:</b>
            <ul>
                <li><b>Security:</b> Prevents clients from modifying read-only fields (like ID, creation dates).</li>
                <li><b>Flexibility:</b> The data model for reading and writing can differ.</li>
            </ul>
        </div>
    </div>
</span>
<span class="code-line">            <span class="badge-inline" data-context-group="order:write" data-operation="PostDenorm">Order::GROUP_WRITE</span>,</span>
<span class="code-line">            <span class="badge-inline" data-context-group="order-item:write" data-operation="PostDenorm">OrderItem::GROUP_WRITE</span>,</span>
<span class="code-line">            <span class="badge-inline" data-context-group="product:write" data-operation="PostDenorm">Product::GROUP_WRITE</span></span>
<span class="code-line">        <span class="php-attr">]],</span></span>
<span class="code-line">        <span class="php-attr">normalizationContext: ['groups' => [</span></span>
<span class="code-line">            <span class="badge-inline" data-context-group="order:read" data-operation="PostNorm">Order::GROUP_READ</span>,</span>
<span class="code-line">            <span class="badge-inline" data-context-group="order-item:read" data-operation="PostNorm">OrderItem::GROUP_READ</span></span>
<span class="code-line">        <span class="php-attr">]]</span></span>
<span class="code-line">    <span class="php-attr">)</span></span>
<span class="code-line"><span class="php-attr">])]</span></span>
<span class="code-line"><span class="php-keyword">class</span> <span class="php-entity-name">Order</span> {</span>
<span class="code-line">    <span class="php-keyword">public const</span> <span class="php-const">GROUP_READ</span> = <span class="php-string">'order:read'</span>;
    <div class="tooltip-container">
        <span class="tooltip-icon">üí°</span>
        <div class="tooltip-text">
            <h4>1. Define Groups as Constants in Entities</h4>
            <p><b>Rule:</b> Instead of writing group names as strings (<code>'order:read'</code>), declare them as public constants within the corresponding entity.</p>
            <b>Justification:</b>
            <ul>
                <li><b>Error Prevention:</b> A typo in a constant name causes a fatal error, while a typo in a string can go unnoticed.</li>
                <li><b>Ease of Refactoring:</b> Rename a group in one place.</li>
                <li><b>Autocomplete:</b> Your IDE will help you.</li>
            </ul>
        </div>
    </div>
</span>
<span class="code-line">    <span class="php-keyword">public const</span> <span class="php-const">GROUP_WRITE</span> = <span class="php-string">'order:write'</span>;</span>

<span class="code-line field-block" data-entity="Order" data-field-name="id">
        <span class="php-attr">#[Groups([<span class="badge-inline field-badge" data-group="order:read">self::GROUP_READ</span>])]</span>
    <div class="tooltip-container">
        <span class="tooltip-icon">üí°</span>
        <div class="tooltip-text">
            <h4>3. Use Only "Own" Groups on Fields</h4>
            <p><b>Rule:</b> Within an entity, when annotating fields, use only the groups defined in that same entity (e.g., <code>self::GROUP_READ</code>).</p>
            <b>Justification:</b>
            <ul>
                <li><b>Low Coupling:</b> The <code>Product</code> entity shouldn't know how <code>Order</code> is serialized.</li>
                <li><b>Single Responsibility Principle:</b> The entity is only responsible for its own data representation.</li>
            </ul>
        </div>
    </div>
</span>
<span class="code-line">        <span class="php-keyword">public</span> <span class="php-type">int</span> <span class="php-variable">$id</span>;</span>
<span class="code-line field-block" data-entity="Order" data-field-name="customerName">
        <span class="php-attr">#[Groups([<span class="badge-inline field-badge" data-group="order:read">self::GROUP_READ</span>, <span class="badge-inline field-badge" data-group="order:write">self::GROUP_WRITE</span>])]</span></span>
<span class="code-line">        <span class="php-keyword">public</span> <span class="php-type">string</span> <span class="php-variable">$customerName</span>;</span>
<span class="code-line field-block" data-entity="Order" data-field-name="orderItems">
        <span class="php-attr">#[Groups([<span class="badge-inline field-badge" data-group="order:read">self::GROUP_READ</span>, <span class="badge-inline field-badge" data-group="order:write">self::GROUP_WRITE</span>])]</span></span>
<span class="code-line">        <span class="php-keyword">public</span> <span class="php-type">OrderItem[]</span> <span class="php-variable">$orderItems</span>;</span>
<span class="code-line">}</span>
                        </div>
                        <div class="tab-panel hidden" id="tab-OrderItem">
<span class="code-line"><span class="php-comment">// OrderItem.php</span></span>
<span class="code-line"><span class="php-keyword">class</span> <span class="php-entity-name">OrderItem</span> {</span>
<span class="code-line">    <span class="php-keyword">public const</span> <span class="php-const">GROUP_READ</span> = <span class="php-string">'order-item:read'</span>;</span>
<span class="code-line">    <span class="php-keyword">public const</span> <span class="php-const">GROUP_WRITE</span> = <span class="php-string">'order-item:write'</span>;</span>
<span class="code-line"></span>
<span class="code-line field-block" data-entity="OrderItem" data-field-name="quantity">
        <span class="php-attr">#[Groups([<span class="badge-inline field-badge" data-group="order-item:read">self::GROUP_READ</span>, <span class="badge-inline field-badge" data-group="order-item:write">self::GROUP_WRITE</span>])]</span></span>
<span class="code-line">        <span class="php-keyword">public</span> <span class="php-type">int</span> <span class="php-variable">$quantity</span>;</span>
<span class="code-line field-block" data-entity="OrderItem" data-field-name="product">
        <span class="php-attr">#[Groups([<span class="badge-inline field-badge" data-group="order-item:read">self::GROUP_READ</span>, <span class="badge-inline field-badge" data-group="order-item:write">self::GROUP_WRITE</span>])]</span></span>
<span class="code-line">        <span class="php-keyword">public</span> <span class="php-type">Product</span> <span class="php-variable">$product</span>;</span>
<span class="code-line">}</span>
                        </div>
                        <div class="tab-panel hidden" id="tab-Product">
<span class="code-line"><span class="php-comment">// Product.php</span></span>
<span class="code-line"><span class="php-keyword">class</span> <span class="php-entity-name">Product</span> {</span>
<span class="code-line">    <span class="php-keyword">public const</span> <span class="php-const">GROUP_READ</span> = <span class="php-string">'product:read'</span>;</span>
<span class="code-line">    <span class="php-keyword">public const</span> <span class="php-const">GROUP_WRITE</span> = <span class="php-string">'product:write'</span>;</span>
<span class="code-line"></span>
<span class="code-line field-block" data-entity="Product" data-field-name="id">
        <span class="php-attr">#[Groups([<span class="badge-inline field-badge" data-group="product:read">self::GROUP_READ</span>, <span class="badge-inline field-badge" data-group="order-item:read">self::GROUP_READ</span>])]</span></span>
<span class="code-line">        <span class="php-keyword">public</span> <span class="php-type">int</span> <span class="php-variable">$id</span>;</span>
<span class="code-line field-block" data-entity="Product" data-field-name="name">
        <span class="php-attr">#[Groups([<span class="badge-inline field-badge" data-group="product:read">self::GROUP_READ</span>, <span class="badge-inline field-badge" data-group="product:write">self::GROUP_WRITE</span>])]</span></span>
<span class="code-line">        <span class="php-keyword">public</span> <span class="php-type">string</span> <span class="php-variable">$name</span>;</span>
<span class="code-line field-block" data-entity="Product" data-field-name="sku">
        <span class="php-attr">#[Groups([<span class="badge-inline field-badge" data-group="product:read">self::GROUP_READ</span>])]</span></span>
<span class="code-line">        <span class="php-keyword">public</span> <span class="php-type">string</span> <span class="php-variable">$sku</span>;</span>
<span class="code-line field-block" data-entity="Product" data-field-name="price">
        <span class="php-attr">#[Groups([<span class="badge-inline field-badge" data-group="product:read">self::GROUP_READ</span>, <span class="badge-inline field-badge" data-group="product:write">self::GROUP_WRITE</span>])]</span></span>
<span class="code-line">        <span class="php-keyword">public</span> <span class="php-type">float</span> <span class="php-variable">$price</span>;</span>
<span class="code-line">}</span>
                        </div>
                    </code></pre>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –û–∫–Ω–æ –±—Ä–∞—É–∑–µ—Ä–∞ -->
            <div class="lg:w-1/2 bg-white rounded-xl shadow-lg flex flex-col">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center gap-2 bg-gray-100 rounded-lg p-2">
                        <select id="http-method" class="http-select font-bold rounded p-2 focus:outline-none w-24">
                            <option value="GET" selected>GET</option>
                            <option value="POST">POST</option>
                        </select>
                        <div class="bg-white rounded p-2 w-full text-gray-700 text-sm truncate">
                            https://api.example.com/orders/1
                        </div>
                    </div>
                </div>
                
                <div class="p-6 flex-grow flex flex-col">
                    <div id="post-view-tabs" class="hidden border-b border-gray-200 mb-4">
                        <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                            <button data-target="request" class="post-tab-btn whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Request</button>
                            <button data-target="response" class="post-tab-btn whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Response</button>
                        </nav>
                    </div>

                    <div id="get-view" class="flex-grow">
                        <h2 id="get-title" class="text-2xl font-bold text-gray-800 mb-4"></h2>
                        <div class="bg-gray-800 text-white p-4 rounded-lg text-sm h-full overflow-x-auto">
                            <pre><code id="json-output-get" class="language-json"></code></pre>
                        </div>
                    </div>

                    <div id="post-view" class="hidden flex-grow flex flex-col">
                        <div id="request-panel" class="post-panel flex-grow flex flex-col">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ (Denormalization)</h2>
                            <div class="bg-gray-800 text-white p-4 rounded-lg text-sm h-full overflow-x-auto">
                                <pre><code id="json-output-request" class="language-json"></code></pre>
                            </div>
                        </div>
                        <div id="response-panel" class="post-panel hidden flex-grow flex flex-col">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (Normalization)</h2>
                            <div class="bg-gray-800 text-white p-4 rounded-lg text-sm h-full overflow-x-auto">
                                <pre><code id="json-output-response" class="language-json"></code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const entityCodeContainer = document.getElementById('entity-code');
    const httpMethodSelector = document.getElementById('http-method');
    
    // Views
    const getView = document.getElementById('get-view');
    const postView = document.getElementById('post-view');
    const postViewTabs = document.getElementById('post-view-tabs');
    const postTabButtons = document.querySelectorAll('.post-tab-btn');
    const postPanels = document.querySelectorAll('.post-panel');

    // JSON outputs
    const jsonOutputGet = document.getElementById('json-output-get');
    const jsonOutputRequest = document.getElementById('json-output-request');
    const jsonOutputResponse = document.getElementById('json-output-response');
    
    // Entity tabs
    const entityTabsContainer = document.getElementById('entity-tabs');
    const entityTabPanels = document.querySelectorAll('.tab-panel');
    const entityTabButtons = document.querySelectorAll('.tab-btn');

    const fullData = {
        id: 1,
        customerName: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤',
        orderItems: [
            {
                quantity: 2,
                product: { id: 101, name: 'Symfony: The Fast Track', sku: 'BOOK-S7', price: 39.99 }
            },
            {
                quantity: 1,
                product: { id: 102, name: 'API Platform: From A to Z', sku: 'BOOK-APIP', price: 45.50 }
            }
        ]
    };

    const groupColors = {
        'order:read': { active: 'bg-blue-500 text-white border-blue-500', inactive: 'bg-gray-700 text-gray-300 border-gray-600' },
        'order-item:read': { active: 'bg-green-500 text-white border-green-500', inactive: 'bg-gray-700 text-gray-300 border-gray-600' },
        'product:read': { active: 'bg-teal-500 text-white border-teal-500', inactive: 'bg-gray-700 text-gray-300 border-gray-600' },
        'order:write': { active: 'bg-yellow-500 text-black border-yellow-500', inactive: 'bg-gray-700 text-gray-300 border-gray-600' },
        'order-item:write': { active: 'bg-lime-500 text-black border-lime-500', inactive: 'bg-gray-700 text-gray-300 border-gray-600' },
        'product:write': { active: 'bg-orange-500 text-white border-orange-500', inactive: 'bg-gray-700 text-gray-300 border-gray-600' }
    };

    function updateBadgeAppearance() {
        document.querySelectorAll('.badge-inline').forEach(badge => {
            const group = badge.dataset.group || badge.dataset.contextGroup;
            const colors = groupColors[group];
            if (!colors) return;
            badge.classList.remove(...Object.values(colors).join(' ').split(' '));
            if (badge.classList.contains('active')) {
                badge.classList.add(...colors.active.split(' '));
            } else {
                badge.classList.add(...colors.inactive.split(' '));
            }
        });
    }

    function isFieldVisible(entity, fieldName, contextGroups) {
        const fieldBlock = document.querySelector(`.field-block[data-entity="${entity}"][data-field-name="${fieldName}"]`);
        if (!fieldBlock) return false;
        const activeFieldBadges = fieldBlock.querySelectorAll('.field-badge.active');
        const activeGroupsForField = Array.from(activeFieldBadges).map(b => b.dataset.group);
        return activeGroupsForField.some(g => contextGroups.includes(g));
    }

    function buildVisibleData(data, contextGroups) {
        let visibleData = {};
        if (isFieldVisible('Order', 'id', contextGroups)) visibleData.id = data.id;
        if (isFieldVisible('Order', 'customerName', contextGroups)) visibleData.customerName = data.customerName;
        if (isFieldVisible('Order', 'orderItems', contextGroups)) {
            visibleData.orderItems = data.orderItems.map(item => {
                let visibleItem = {};
                if (isFieldVisible('OrderItem', 'quantity', contextGroups)) visibleItem.quantity = item.quantity;
                
                if (isFieldVisible('OrderItem', 'product', contextGroups)) {
                    if (contextGroups.includes('product:read')) {
                        visibleItem.product = {};
                        const product = item.product;
                        if (isFieldVisible('Product', 'id', contextGroups)) visibleItem.product.id = product.id;
                        if (isFieldVisible('Product', 'name', contextGroups)) visibleItem.product.name = product.name;
                        if (isFieldVisible('Product', 'sku', contextGroups)) visibleItem.product.sku = product.sku;
                        if (isFieldVisible('Product', 'price', contextGroups)) visibleItem.product.price = product.price;
                        if (Object.keys(visibleItem.product).length === 0) delete visibleItem.product;
                    } else {
                        visibleItem.product = `/api/products/${item.product.id}`;
                    }
                }
                return Object.keys(visibleItem).length > 0 ? visibleItem : null;
            }).filter(Boolean);
            if (visibleData.orderItems.length === 0) delete visibleData.orderItems;
        }
        return visibleData;
    }

    function renderJsonRecursive(obj, indent = '  ') {
        if (obj === null || typeof obj !== 'object') {
            const valueType = typeof obj === 'number' ? 'json-number' : 'json-string';
            return `<span class="${valueType}">${JSON.stringify(obj)}</span>`;
        }
        let html = Array.isArray(obj) ? '[\n' : '{\n';
        const keys = Object.keys(obj);
        keys.forEach((key, index) => {
            const isLast = index === keys.length - 1;
            const value = obj[key];
            if (Array.isArray(obj)) {
                html += `${indent}${renderJsonRecursive(value, indent + '  ')}${isLast ? '' : ','}\n`;
            } else {
                html += `${indent}<span class="json-key">"${key}"</span>: ${renderJsonRecursive(value, indent + '  ')}${isLast ? '' : ','}\n`;
            }
        });
        const closingIndent = indent.slice(0, -2);
        html += closingIndent + (Array.isArray(obj) ? ']' : '}');
        return html;
    }

    function updateJson() {
        const method = httpMethodSelector.value;
        
        if (method === 'GET') {
            getView.classList.remove('hidden');
            postView.classList.add('hidden');
            postViewTabs.classList.add('hidden');
            document.getElementById('get-title').textContent = '–û—Ç–≤–µ—Ç (Normalization)';

            let contextGroups = [];
            document.querySelectorAll(`.badge-inline[data-context-group][data-operation="Get"]`).forEach(badge => {
                if (badge.classList.contains('active')) {
                    contextGroups.push(badge.dataset.contextGroup);
                }
            });
            const visibleData = buildVisibleData(fullData, contextGroups);
            jsonOutputGet.innerHTML = renderJsonRecursive(visibleData);

        } else { // POST
            getView.classList.add('hidden');
            postView.classList.remove('hidden');
            postViewTabs.classList.remove('hidden');

            // Request (Denormalization)
            let denormGroups = [];
            document.querySelectorAll(`.badge-inline[data-context-group][data-operation="PostDenorm"]`).forEach(badge => {
                if (badge.classList.contains('active')) {
                    denormGroups.push(badge.dataset.contextGroup);
                }
            });
            const requestData = buildVisibleData(fullData, denormGroups);
            jsonOutputRequest.innerHTML = renderJsonRecursive(requestData);

            // Response (Normalization)
            let normGroups = [];
            document.querySelectorAll(`.badge-inline[data-context-group][data-operation="PostNorm"]`).forEach(badge => {
                if (badge.classList.contains('active')) {
                    normGroups.push(badge.dataset.contextGroup);
                }
            });
            const responseData = buildVisibleData(fullData, normGroups);
            jsonOutputResponse.innerHTML = renderJsonRecursive(responseData);
        }
    }

    function handleEntityTabClick(e) {
        const targetEntity = e.target.dataset.target;
        entityTabButtons.forEach(btn => {
            const isTarget = btn.dataset.target === targetEntity;
            btn.classList.toggle('border-indigo-500', isTarget);
            btn.classList.toggle('text-indigo-600', isTarget);
            btn.classList.toggle('border-transparent', !isTarget);
            btn.classList.toggle('text-gray-500', !isTarget);
            btn.classList.toggle('hover:text-gray-700', !isTarget);
            btn.classList.toggle('hover:border-gray-300', !isTarget);
        });
        entityTabPanels.forEach(panel => {
            panel.classList.toggle('hidden', panel.id !== `tab-${targetEntity}`);
        });
    }

    function handlePostViewTabClick(e) {
        const targetPanel = e.target.dataset.target; // 'request' or 'response'
        postTabButtons.forEach(btn => {
            const isTarget = btn.dataset.target === targetPanel;
            btn.classList.toggle('border-indigo-500', isTarget);
            btn.classList.toggle('text-indigo-600', isTarget);
            btn.classList.toggle('border-transparent', !isTarget);
            btn.classList.toggle('text-gray-500', !isTarget);
        });
        postPanels.forEach(panel => {
            panel.classList.toggle('hidden', panel.id !== `${targetPanel}-panel`);
        });
    }

    function setMethodSelectorColor() {
        if (httpMethodSelector.value === 'GET') {
            httpMethodSelector.classList.remove('http-post');
            httpMethodSelector.classList.add('http-get');
        } else {
            httpMethodSelector.classList.remove('http-get');
            httpMethodSelector.classList.add('http-post');
        }
    }

    function initializeState() {
        document.querySelectorAll('.badge-inline').forEach(badge => badge.classList.add('active'));
        updateBadgeAppearance();
        entityTabsContainer.querySelector('.tab-btn').click();
        postViewTabs.querySelector('.post-tab-btn').click();
        setMethodSelectorColor();
        updateJson();
    }

    entityTabsContainer.addEventListener('click', (e) => {
        if (e.target.matches('.tab-btn')) handleEntityTabClick(e);
    });
    postViewTabs.addEventListener('click', (e) => {
        if (e.target.matches('.post-tab-btn')) handlePostViewTabClick(e);
    });
    entityCodeContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('badge-inline')) {
            e.target.classList.toggle('active');
            updateBadgeAppearance();
            updateJson();
        }
    });
    httpMethodSelector.addEventListener('change', () => {
        setMethodSelectorColor();
        updateJson();
    });

    initializeState();
});
</script>

</body>
</html>
